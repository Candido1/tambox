{% extends "almacen/base_almacen.html" %}
{% block cuerpo %}
<h3>Movimientos / {{ movimiento.id_movimiento }}</h3>
<form role="form" action="{% url 'almacen:modificar_salida_almacen' movimiento.id_movimiento %}" method="post">	
	<div class="row">
		<div class="col-lg-10">
			<input type="submit" class="btn btn-primary" name="submit" value="Guardar">
			<button type="button" class="btn btn-default" onclick="location.href='{% url 'almacen:detalle_movimiento' movimiento.pk %}'">
				Cancelar
			</button>
		</div>
		<div class="col-lg-2 text-right">
			<div class="btn-group">
				<button class="btn btn-default" type="button" onclick="location.href='{% url 'almacen:modificar_movimiento' movimiento.anterior %}';">
					<span class="glyphicon glyphicon-step-backward"></span>
				</button>
				<button class="btn btn-default" type="button" onclick="location.href='{% url 'almacen:modificar_movimiento' movimiento.siguiente %}';">
					<span class="glyphicon glyphicon-step-forward"></span>
				</button>
				<button class="btn btn-default" type="button" onclick="location.href='{% url 'almacen:movimientos' %}';">
					<span class="glyphicon glyphicon-th-list"></span>
				</button>
			</div>
		</div>
	</div>
	<hr />
	<div class="panel panel-primary">
		<div class="panel-body">					
			{% csrf_token %}
			<div class="form-group">
				<div class="row">
					<div class="col-md-3">
						<label>Id Movimiento:</label>  
						{{ form.id_movimiento }}
					</div>
				</div>
				<div class="row">
					<div class="col-md-3">
						<label>Tipo de Salida:</label>  
						{{ form.tipo_movimiento }}
					</div>
					<div class="col-md-3">
						<label>Almacén:</label> 
						{{ form.almacen }}
					</div>
				</div>
			</div>			
			<div class="form-group">	
				<div class="row">
					<div class="col-md-3">			
						<label>Fecha:</label> 
						{{ form.fecha }}
					</div>
					<div class="col-md-3">	
						<label>Hora:</label> 
						{{ form.hora }}
					</div>
					<div class="col-md-3">	
						<label>Oficina a atender:</label> 
						{{ form.oficina }}
					</div>
				</div>						
			</div>			
			<div class='form-group'>
				<div class="row">
					<div class="col-md-3">	
						<label>DOC. REFER:</label>  
						{{ form.tipo_documento }}
					</div>
					<div class="col-md-3">
						<label>SERIE:</label>
						{{ form.serie }}
					</div>
					<div class="col-md-3">
						<label>NUMERO:</label>
						{{ form.numero }}
					</div>
				</div>
			</div>			
			<div class="row">
				<div class="col-lg-10">							
				</div>	
				<div class="col-lg-2">
					<div class='form-group'>
						<button id="crear_detalle" href="#" class="btn btn-info btn-block">
							<span class="glyphicon glyphicon-plus">AGREGAR</span>
						</button>
					</div>
				</div>	
			</div>
			<div class="row">
				<div class="col-lg-12">
					<table id="detalles" class="table table-striped table-bordered table-hover">
						<thead>
							<tr>
								<th>ID Producto</th>
								<th>Producto</th>
								<th>Unidad</th>	
								<th>Cantidad</th>	
								<th>Precio</th>
								<th>Valor</th>
								<th>Acción</th>
							</tr>
						</thead>
						<tbody>
						{% for detalle in detalles %}
							<tr>
								<input type='hidden' name="cod_detalle{{ detalle.nro_detalle }}" id="cod_detalle{{ detalle.nro_detalle }}" value="{{ detalle.nro_detalle }}"/>
						  		<td>
						  			<input class='form-control' type='text' size=14 readonly='readonly' name="codigo{{ detalle.nro_detalle }}" id="codigo{{ detalle.nro_detalle }}" value="{{ detalle.producto.codigo }}"/>
						  		</td>
						  		<td>
						  			<input class='form-control' type='text' size=25 readonly='readonly' name="nombre{{ detalle.nro_detalle }}" id="nombre{{ detalle.nro_detalle }}" value="{{ detalle.producto.descripcion }}"/>
						  		</td>
						  		<td>
						  			<input class='form-control' type='text' size=10 readonly='readonly' name="unidad{{ detalle.nro_detalle }}" id="unidad{{ detalle.nro_detalle }}" value="{{ detalle.producto.unidad_medida.descripcion }}"/>
						  		</td>
						  		<td>
						  			<input class='form-control' type='numeric' size=5 name="cantidad{{ detalle.nro_detalle }}" id="cantidad{{ detalle.nro_detalle }}" value="{{ detalle.cantidad }}"/>
						  		</td>
						  		<td>
						  			<input class='form-control' type='numeric' readonly='readonly' size=10 name="precio{{ detalle.nro_detalle }}" id="precio{{ detalle.nro_detalle }}" value="{{ detalle.precio }}"/>
						  		</td>
						  		<td>
						  			<input class='form-control' type='text' readonly='readonly' size=14 name="valor{{ detalle.nro_detalle }}" id="valor{{ detalle.nro_detalle }}" value="{{ detalle.valor }}"/>
						  		</td>
						  		<td>
						  			<button class='eliminar btn btn-small btn-danger' type='button' id="btnBorrar{{ detalle.nro_detalle }}" name='guardar'><span class='glyphicon glyphicon-remove'></span>
						  			</button>
						  		</td>
							</tr>
						{% endfor %}	
						</tbody>
						</tbody>				
					</table>
				</div>
			</div>
			<div class="row">
				<div class="col-lg-12">
					<table id="tabla_total" class="table table-striped table-hover">
						<tbody>	
							<tr>
								<td WIDTH="50">											
								</td>
								<td WIDTH="590">
									
								</td>
								<td WIDTH="50">
									TOTAL
								</td>
								<td>
									{{ form.total }}
								</td>
								<td WIDTH="80">
								</td>
							</tr>		
						</tbody>				
					</table>
				</div>
			</div>
			<div class="row">
				<div class="col-lg-12">
					<label>OBSERVACIONES:</label>	
					{{ form.observaciones }}
				</div>
			</div>
			<div id="popup"></div>
			<div class="row">
				<div class="col-lg-4">
					{{ form.cdetalles }}
				</div>
			</div>
		</div>
	</div>
</form>

{% endblock cuerpo %}

{% block js %}
<script>
	var total=0;
	var tipo_salida;
	var contDetalles = parseInt($('#id_cdetalles').val());
	var ultimo_item = contDetalles;
	$("#id_fecha").datepicker();
	$('#id_hora').wickedpicker({now: mostrarhora(), twentyFour: true, title:'Hora de Salida', showSeconds: true});
	$("#id_tipo_movimiento").on('change',verificar_solicita_documento);	
	
	function agregarCero(n)
	{
	  if(n>9)
	  {
	    return n
	  }
	  else{
	    return "0"+n;
	  }
	}
	
	function verificar_solicita_documento()
	{		
		tipo_salida = $('#id_tipo_movimiento').val();
		$.ajax({
			data : {'tipo': tipo_salida},
			url : "{% url 'almacen:verificar_solicita_documento' %}",
			type : 'get',
			success : function(data)
			{
				if(data.solicita_documento){
					$('#id_tipo_documento').prop("disabled", false );
					$('#id_serie').prop("disabled", false );
					$('#id_numero').prop("disabled", false );
				}
				else{
					$('#id_tipo_documento').prop("disabled", true );
					$('#id_serie').prop("disabled", true );
					$('#id_numero').prop("disabled", true );
				}
			}
		});
	}
	
	function mostrarhora()
	{
		var f=new Date();
		cad=agregarCero(f.getHours())+" : "+agregarCero(f.getMinutes())+" : "+agregarCero(f.getSeconds());
		return cad;
	}
	
	$(document).on("click",".eliminar",function()
	{
		var parent = $(this).parent().parent();		
		$(parent).remove();
		total=total-parseFloat(valor);
		$("#total").val(total);
	});	
    
	$('#crear_detalle').click(function(e)
	{
		e.preventDefault();
		var alm=$('#id_almacen').val().trim();
		if(alm != '') 
		{			
			ventana = $('#popup').dialog(
			{
				title: "Agregar Detalle",
				open: function ()
		        {
					var url="{% url 'almacen:crear_detalle_salida' 'cod_alm' %}".replace('cod_alm', alm);
		            $(this).load(url);
		        },
				width: 950,
				modal: true,
				resizable: false,
				position: { my: "center", at: "center", of: "#page-wrapper"},
		      	buttons: {
		          "Aceptar": agregarDetalle,
		          "Cancelar": cerrarDetalle
		        }
			}).dialog('open').load(this.href)
		}
		else
		{
			alert("Previamente debe haber seleccionado el almacén");
		}
 	});
 	
	function agregarDetalle() 
	{
		contDetalles = contDetalles + 1;	
		cantidad = $("#id_cantidad").val();
		if(cantidad>0)
		{
			codigo = $("#id_codigo").val(),
		    nombre = $("#id_nombre").val(),
		    unidad = $("#id_unidad").val(),
		    
			precio = $("#id_precio").val();
			valor = $("#id_valor").val();
			total = total+parseFloat(valor);
			$("#detalles tbody").append( 
			"<tr>" +
		  	"<td><input class='form-control' type='text' size=14 readonly='readonly' name='codigo"+contDetalles+"' id='numero' value='" + codigo + "'/></td>" +
		  	"<td><input class='form-control' type='text' size=25 readonly='readonly' name='nombre"+contDetalles+"' id='numero' value='" + nombre + "'/></td>" +
		  	"<td><input class='form-control' type='text' size=10 readonly='readonly' name='unidad"+contDetalles+"' id='numero' value='" + unidad + "'/></td>" +
		  	"<td><input class='form-control' type='numeric' size=5 name='cantidad"+contDetalles+"' id='numero' value='" + cantidad + "'/></td>" +
		  	"<td><input class='form-control' type='numeric' readonly='readonly' size=10 name='precio"+contDetalles+"' id='numero' value='" + precio + "'/></td>" +
		  	"<td><input class='form-control' type='text' readonly='readonly' size=14 name='valor"+contDetalles+"' id='numero' value='" + valor + "'/></td>" +
		  	"<td><button class='eliminar btn btn-small btn-danger' type='button' id='btnBorrar"+contDetalles+"' name='guardar'><span class='glyphicon glyphicon-remove'></span></button></td>" +
			"</tr>");	
			$("#total").val(total);
		}		
		ventana.dialog( "close" );
    }
	
	function cerrarDetalle()
	{
		ventana.dialog("close");
	}
	
	$("form").submit(function(event) 
	{
		var cont=0;
		tipo_salida = $('#id_tipo_movimiento').val();
		$('#id_cdetalles').val(contDetalles);
		var almacen = $('#id_almacen').val().trim();
		var fecha = $('#id_fecha').val().trim();		
		var tipo_documento;
		var serie;
		var numero;
		if(tipo_salida != '') 
		{			
			if(almacen != '') 
			{			
				if(fecha != '')
				{					
					if (contDetalles > 0)
					{
						return;
					}
					else
					{
						alert("No ha ingresado ningún detalle");	
					}
				}
				else
				{
					alert("No ha seleccionado fecha");
				}
			}
			else
			{
				alert("No ha seleccionado almacén");
			}
		}
		else
		{
			alert("No ha seleccionado tipo de salida");
		}		
		event.preventDefault();
	});
   	
</script>
{% endblock js %}